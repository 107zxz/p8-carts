pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
function _init()
	-- inverted circle
	poke(0x5f34, 0x2)
	
	-- palette
	poke(0x5f2e,1)
	pal({[1]=-14,[3]=-3,[4]=-16,[10]=-9,[12]=-1}, 1 )
	palt(0x0010)

	p={x=60,y=103,f=false,s=34}
end

function _update()
	update_player()
	
	-- cutscene
	update_cutscene()
	update_dialogue()
end

function _draw()
	cls()
	map()
	spr(p.s,p.x,p.y,1,2,p.f)
	
	-- npcs
--	spr(34,56,56,1,2)
	
	-- darkness
	circfill(
		64,64,
		68+sin(t()/5)*4,0x1800
	)
	
	draw_dialogue()

	-- debug
	print(
		"{"..p.x..","..p.y.."}",
		0,0,
		13
	)
end
-->8
-- cutscene / dialog
-- fmt: {condition,action}

cutscene_queue={
--	{ -- alex dialogue on approach
--		function() return p.y<72 end,
--		function() dial_queue={
--"\f9hey, director",
--"\f9guess its finally the\n"..
--"\"big day\"."
--		} end
--	}
}

-- same format, but never
-- cleared
cutscene_always={
	{ -- alex interact dialogue
		function()
			return 
						tr_in_area(70,0,88,69)
						and btnp(ðŸ…¾ï¸)
						and #dial_queue==0
		end,
		function() 
			dial_queue={
"\f9i've almost finished\n"..
"prep for the final dive.",
"\f9the \f8cage\f9 will be\n"..
"ready for you by the time\n"..
"you've geared up."
		} end
	},
	{ -- pit interact
		function()
			return 
				tr_in_area(39,50,71,58)
				and #dial_queue==0
				and p.s==34
				and btnp(ðŸ…¾ï¸)
		end,
		function()
			dial_queue={
"everything i've worked\n"..
"for is down there.",
"to think i'll be going\n"..
"myself this time..."
			}
		end
	},
	{ -- no turning back
		function()
			return 
				tr_in_area(55,105,65,128)
				and p.s==33
		end,
		function()
			p.s=34
			dial_queue={
"no turning back now."
			}
		end
	},
	{ -- shop
		function()
			return 
				tr_in_area(0,0,8,128)
				and p.f
		end,
		function()
			load"lab_2"
		end
	}
}

function update_cutscene()
	for event in all(cutscene_always) do
		if event[1]() then
			event[2]()
		end
	end

	-- story queue
	if #cutscene_queue==0 then
		return
	end
	
	-- trigger condition
	if cutscene_queue[1][1]() then
		cutscene_queue[1][2]()
		deli(cutscene_queue,1)
	end
end

dial_queue={}
dial_prog=1
function draw_dialogue()
	if #dial_queue == 0 then
		return
	end

	-- textbox
	local text=
		sub(dial_queue[1],1,dial_prog)
	
	rrectfill(2,96,124,30,1,0)
	
	color(6)
	
	print(text,5,99)
	print("[z]",112,118)
	rrect(2,96,124,30,1)
end

function update_dialogue()
	if #dial_queue == 0 then
		return
	end
	
	if btnp(ðŸ…¾ï¸) 
	and dial_prog>#(dial_queue[1]) then
		deli(dial_queue,1)
		dial_prog=1
	end
	
	dial_prog+=1
end
-->8
-- player
function update_player()

	-- don't move during dialogue
	if #dial_queue!=0 then
		return
	end
	
	
	local dx,dy=0,0

	dx+=btn(âž¡ï¸) and 1 or 0
	dx-=btn(â¬…ï¸) and 1 or 0

	dy+=btn(â¬‡ï¸) and 1 or 0
	dy-=btn(â¬†ï¸) and 1 or 0
	
	p.f=p.f and not (dx>0) 
					or (dx<0) 
	
	p.s=(dx!=0) and 1
					or dy>0 and 33
					or dy<0 and 34
	    or p.s

	if mget(
			(p.x+dx*4+4)\8,
			(p.y+dy*5+10)\8
		) == 2 then
		p.x+=dx
		p.y+=dy
	end
end
-->8
-- story triggers
function tr_in_area(x,y,x2,y2)
	return p.x>=x
				and p.y>=y
				and p.x<=x2
				and p.y<=y2
end
__gfx__
00000000bbbbbbbb00000000bbbbbbbbb433444bbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbb44444440bbbbbbbbb433444bbbb88bbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000
00700700bbbbbbbb00000040b3bbb3bbb433444bbbbbb8ddddd8dbbb000000000000000000000000000000000000000000000000000000000000000000000000
00077000bbbbbbbb00000040333b333bb433444bbbbdd3311111d3bb000000000000000000000000000000000000000000000000000000000000000000000000
00077000bbbdddbb00000040bbb4bbb4b433444b8bdd31144444133b000000000000000000000000000000000000000000000000000000000000000000000000
00700700bbd666db00000040bbb3bbb3b433444b8bd3144f44cf413b000000000000000000000000000000000000000000000000000000000000000000000000
00000000bd6d72fb00000040bbb3bbb3b433444bb8314f40c000418b000000000000000000000000000000000000000000000000000000000000000000000000
00000000bd6fffbb00000040bbb3bbb3b433444bbd144c0000c4413b000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbdf55bbbbbbbbbbbbbbbbbbbb4344bbbd140000000f413b000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbddffbbbaaabbabbbbbbbbbbb4344bbbd1fc00cc00f1d3b000000000000000000000000000000000000000000000000000000000000000000000000
00000000b667dddbbbbbbbbbbbbbbbbbbb4344bbbd1400000f41d33b000000000000000000000000000000000000000000000000000000000000000000000000
00000000b6677ddb5baaaab5bbbbbbbbbb4344bbb3140c044f1338bb000000000000000000000000000000000000000000000000000000000000000000000000
00000000b66777db5bbbbbb5bbbbbbbbbb4344bbb3144f44113d3b8b000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb6777bb5bbbbbb5bbbbbbbbbb4344bbb8d144113d33bb8b000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb7bb7bb5babbab5bbbbbbbbbb4344bbbb3d11ddd38bbbbb000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb55b55b55bbbb55bbbbbbbbbb4344bbbbb383333bb88bbb000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb0000000000000000000050500000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbbbbbbbbbbbaaabbabbbbbbbbb0000000000000000000444000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb0000000000000000005464000000000000000000000000000000000000000000000000000000000000000000
00000000bbbbbbbbbbbbbbbb5baaaab5bbbbbbbb0000000000000000576444500000000000000000000000000000000000000000000000000000000000000000
00000000bbddddbbbbddddbb5bbdddb5bbbbbbbb0000000000000000764464000000000000000000000000000000000000000000000000000000000000000000
00000000bd6666dbbd6666dbbbddddbbbbbbbbbb0000000000000000766444000000000000000000000000000000000000000000000000000000000000000000
00000000b527725bbd6666dbbb9999bbbbbbbbbb0000000000000000764464000000000000000000000000000000000000000000000000000000000000000000
00000000bdffffdbbdf66fdbbbf99fbbbbbbbbbb0000000000000000766444500000000000000000000000000000000000000000000000000000000000000000
00000000bbf55fbbbbf55fbbbbb99bbbbbbbbbbb0000000000000000764460000000000000000000000000000000000000000000000000000000000000000000
00000000bbddddbbbb6666bbbb6696bbbbbbbbbb9444944094449449766444000000000000000000000000000000000000000000000000000000000000000000
00000000bd6666dbbd6666dbbd6669dbbbbbbbbb4444444044444440764464000000000000000000000000000000000000000000000000000000000000000000
00000000bd6776dbbd6776dbbf6779fbbbbbbbbb944a4a4a4a4a4a49766444500000000000000000000000000000000000000000000000000000000000000000
00000000bd6776dbbd6776dbbf6796fbbbbbbbbb0444444444444440574464000000000000000000000000000000000000000000000000000000000000000000
00000000bb6776bbbb6776bbbb6776bbbbbbbbbb0094444444444900005444000000000000000000000000000000000000000000000000000000000000000000
00000000bb7bb7bbbb7bb7bbbb7bb7bbbbbbbbbb0007aaaaaaaa7000000444000000000000000000000000000000000000000000000000000000000000000000
00000000bb5bb5bbbb5bb5bbbb5bb5bbbbbbbbbb0009777777779000000054500000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000002020402020402020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000202020402020402020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002020202000400000400020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002020202000400000400020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303000400000400030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2702020202001400001400020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3702020202001400001423020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000202020202020233020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000002020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000035360000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
