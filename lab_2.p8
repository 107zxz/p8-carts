pico-8 cartridge // http://www.pico-8.com
version 43
__lua__
function reset_pal()
	pal()
	pal({[1]=-14,[3]=-3,[4]=-16,[10]=-9,[12]=-1}, 1 )
	palt(0x0010)
end

function _init()
	cartdata"depth_perception"
	-- set position for return
	dset(0,10)
	dset(1,46)
	
	if dget(2) != 0 then
		dial_queue={}
	end

	poke(0x5f2d,0x3)
	
		-- palette
	poke(0x5f2e,1)
	reset_pal()
	
	-- cursor
	crs=1
end

function _update60()

	update_dialogue()
	if #dial_queue>0 then
		return
	end

	crs=1
	if m_zn(16,16,32,36) then
		crs=3
	end
	
	-- back button
	if m_zn(48,114,80,122) then
		crs=3
		
		if btnp(5) then
		
			if dget(2)==0 then
				add(dial_queue,
				"i should grab some notes."
				)
				return
			end
		
			load"lab_1"
		end
	end
	
	-- select item
	if  m_zn(16,16,32,36)
 and btnp(5) then
	 dset(2,1)
 end
end

function _draw()
	cls()
--	ovalfill(0,120,127,135,13)

	draw_shelves()
	
	-- back btn
	local bcol=7
	if m_zn(48,114,80,122) then
		bcol=8
	end
	line(48,114,64,122,bcol)
	line(64,122,80,114,bcol)
	
	draw_dialogue()
	
	-- cursor
	spr(crs,stat(32),stat(33))
end

function draw_shelves()
	for i=0,2 do
		rrectfill(8,8+i*35,112,28,1,6)
		rrectfill(8,8+i*35+20,112,8,1,13)
	end
	
	-- shadow
	ovalfill(15,34,32,30,3)
	
	if m_zn(16,16,32,36) then
		print("\#1\f8tattered notes\n\fdfollow amy's path",stat(32)+16,stat(33))
		pal{8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8}
		spr(20,16,18,2,2)
		reset_pal()
	end
	
	spr(20,16,17,2,2)
	
	if dget(2) != 0 then
		spr(19,20,9)
	end
end
-->8
-- helpers
function m_zn(x,y,x2,y2)
	return stat(32)>=x
				and stat(32)<=x2
				and stat(33)>=y
				and stat(33)<=y2
end
-->8
-- dialogue
dial_queue={
	"looks like we've used up all\nthe good gear.",
	"notes will have to do."
}
dial_prog=1
function draw_dialogue()
	if #dial_queue == 0 then
		return
	end

	-- textbox
	local text=
		sub(dial_queue[1],1,dial_prog)
	
	rrectfill(2,96,124,30,1,0)
	
	color(6)
	
	print(text,5,99)
	print("[click]",96,118)
	rrect(2,96,124,30,1)
end

function update_dialogue()
	if #dial_queue == 0 then
		return
	end
	
	if btnp(5) 
	and dial_prog>#(dial_queue[1]) then
		deli(dial_queue,1)
		dial_prog=1
	end
	
	dial_prog+=1
end
__gfx__
0000000077bbbbbb77bbbbbbbb7777bbbb777bbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000707bbbbb707bbbbbb707077b770007bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007007007bbbb7007bbbbb770707b7077707b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700070007bbb70707bbbb7700007b70777070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000700007bb707707bb70700007700777070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700700007bb707707bb7000007b7007707b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b7007bbbb7007bbbb700077bb700077b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb77bbbbbb77bbbbbb7777bbbb7777bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4444444444bbbbb8888bbbbbbbbbbbbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb455555555554bbb888888bbbbbbbbc555bbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b45555555555554b88888808bbbbb000ff555bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000455555555555555488888008bbbbb0500fff55bb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000455555555555555480080088bbbbbc5ff11ff55b00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000444555555555544488000888bbb005ff1f1fff5500000000000000000000000000000000000000000000000000000000000000000000000000000000
000000004dd4445555444dd4b880888bbbb000ff1ff1f55100000000000000000000000000000000000000000000000000000000000000000000000000000000
000000004dddd444444dadd4bb8888bbbbb5ff1fffff551b00000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000044ddddddaaddad44bb9999bbb005ffff666551bb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000454dddddaadda454b999099bb000f66699551bbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000454ddddddaddd45499900099bc5ff6588551bbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000455444444444455499090999b5f11651111bbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000445555555555554499090999b55fff651bbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000b44555555555544b99900099bb555ff51bbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bb444444444444bbb999099bbbbb55551bbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000bbb4444444444bbbbb9999bbbbbbb551bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000
